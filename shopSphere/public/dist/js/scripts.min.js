let dataTableInstance,passwordUpdateForm=document.getElementById("passwordForm"),addProductBtn=document.getElementById("addProductBtn"),addProductForm=document.getElementById("addProductForm"),editProductForm=document.getElementById("editProductForm"),errorMsg=document.getElementById("error");function adminFetchProducts(){fetch("/products").then(t=>t.json()).then(t=>{let a=document.getElementById("productsTableBody");a.innerHTML="",dataTableInstance&&dataTableInstance.clear(),t.data.forEach(t=>{var e=[t.name,t.description,t.category,t.price,t.quantity,t.retailer,`<button class="btn btn-primary" onclick="openEditModal('${t._id}')">Edit</button>
                     <button class="btn btn-danger" onclick="deleteProduct('${t._id}')">Delete</button>`];dataTableInstance?dataTableInstance.row.add(e):((e=document.createElement("tr")).innerHTML=`
                        <td>${t.name}</td>
                        <td>${t.description}</td>
                        <td>${t.category}</td>
                        <td>${t.price}</td>
                        <td>${t.quantity}</td>
                        <td>${t.retailer}</td>
                        <td>
                            <button class="btn btn-primary" onclick="openEditModal('${t._id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteProduct('${t._id}')">Delete</button>
                        </td>
                    `,a.appendChild(e))}),dataTableInstance?dataTableInstance.draw():dataTableInstance=new DataTable("#productsTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8,responsive:!0})}).catch(t=>console.error("Error loading products:",t))}function adminModal(t,e){var a=document.getElementById("addProductModal"),o=document.getElementById("editProductModal");M.Modal.init(a),M.Modal.init(o);let n=document.getElementById("addProductCategory"),d=document.getElementById("productCategory"),r=document.getElementById("addProductRetailer"),c=document.getElementById("productRetailer");t.forEach(t=>{var e=document.createElement("option");e.value=t,e.textContent=t,n.appendChild(e.cloneNode(!0)),d.appendChild(e.cloneNode(!0))}),e.forEach(t=>{var e=document.createElement("option");e.value=t,e.textContent=t,r.appendChild(e.cloneNode(!0)),c.appendChild(e.cloneNode(!0))}),M.FormSelect.init(n),M.FormSelect.init(d),M.FormSelect.init(r),M.FormSelect.init(c);a=document.querySelectorAll("select");M.FormSelect.init(a,{dropdownOptions:{constrainWidth:!0,container:document.body}})}function openEditModal(e){fetch("/products/"+e).then(t=>t.json()).then(t=>{document.getElementById("productName").value=t.data.name,document.getElementById("productDescription").value=t.data.description,document.getElementById("productCategory").value=t.data.category,document.getElementById("productPrice").value=t.data.price,document.getElementById("productQuantity").value=t.data.quantity,document.getElementById("productRetailer").value=t.data.retailer,document.getElementById("editProductForm").dataset.productId=e,M.updateTextFields(),M.Modal.getInstance(document.getElementById("editProductModal")).open()}).catch(t=>console.error("Error fetching product details:",t))}async function deleteProduct(t){if(confirm("Are you sure you want to delete this product?"))try{(await fetch(`/products/${t}/delete`,{method:"DELETE"})).ok?(showToast("Product deleted successfully"),adminFetchProducts()):showToast("Error deleting product")}catch(t){console.error("Error:",t),showToast("Error deleting product")}}function fetchOrders(){fetch("/admin/orders").then(t=>t.json()).then(t=>{let i=document.getElementById("ordersTableBody");i.innerHTML="",Array.isArray(t)?(t.forEach(t=>{var e=t.userId?`${t.shippingAddress.street}, ${t.shippingAddress.city}, `+t.shippingAddress.country:"N/A",a=t.userId&&t.userId._id?t.userId.fullName:"N/A",o=t.totalAmount,n=t.status,d=new Date(t.orderedAt).toLocaleDateString(),r=t.shippedAt?new Date(t.shippedAt).toLocaleDateString():"N/A",c=t.deliveredAt?new Date(t.deliveredAt).toLocaleDateString():"N/A";let s="";t.orderItems.forEach(t=>{var e=t.productId?t.productId.name:"Unknown Product",a=t.price,t=t.quantity;s+=`<p>${e} (x${t}) - $${a}</p>`});t=document.createElement("tr");t.innerHTML=`
                        <td>${a}</td>
                        <td>${e}</td>
                        <td>${s}</td>
                        <td>$${o}</td>
                        <td>${n}</td>
                        <td>${d}</td>
                        <td>${r}</td>
                        <td>${c}</td>
                    `,i.appendChild(t)}),$.fn.dataTable.isDataTable("#ordersTable")&&$("#ordersTable").DataTable().destroy(),new DataTable("#ordersTable",{paging:!0,searching:!0,ordering:!0,info:!0,pageLength:8,responsive:!0})):console.error("Expected an array of orders, but got:",t)}).catch(t=>console.error("Error loading orders:",t))}addProductBtn?.addEventListener("click",function(){document.getElementById("addProductName").value="",document.getElementById("addProductDescription").value="",document.getElementById("addProductCategory").value="",document.getElementById("addProductPrice").value="",document.getElementById("addProductQuantity").value="",document.getElementById("addProductRetailer").value="",M.updateTextFields(),M.Modal.getInstance(document.getElementById("addProductModal")).open()}),addProductForm?.addEventListener("submit",function(t){t.preventDefault();t={name:document.getElementById("addProductName").value,description:document.getElementById("addProductDescription").value,category:document.getElementById("addProductCategory").value,price:parseFloat(document.getElementById("addProductPrice").value),quantity:parseInt(document.getElementById("addProductQuantity").value,10),retailer:document.getElementById("addProductRetailer").value};fetch("/products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(t=>t.json()).then(t=>{t.success?(M.Modal.getInstance(document.getElementById("addProductModal")).close(),socket.emit("newItem",{from:"Admin",text:`A new Product ${t.data.name} has been added`,createdAt:(new Date).toISOString()}),showToast("Product added successfully"),adminFetchProducts()):(showToast("Failed to add product"),console.error("Failed to add product"))}).catch(t=>{showToast("There was an error adding the product"),console.error("Error adding product:",t)})}),editProductForm?.addEventListener("submit",function(t){t.preventDefault();var t=this.dataset.productId,e={name:document.getElementById("productName").value,description:document.getElementById("productDescription").value,category:document.getElementById("productCategory").value,price:parseFloat(document.getElementById("productPrice").value),quantity:parseInt(document.getElementById("productQuantity").value,10),retailer:document.getElementById("productRetailer").value};fetch(`/products/${t}/edit`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(t=>t.json()).then(t=>{t.success?(M.Modal.getInstance(document.getElementById("editProductModal")).close(),showToast("Product updated successfully"),adminFetchProducts()):(showToast("Failed to update product"),console.error("Failed to update product"))}).catch(t=>{showToast("There was an error updating the product"),console.error("Error updating product:",t)})}),passwordUpdateForm?.addEventListener("submit",async e=>{e.preventDefault(),errorMsg.textContent="";var e=document.getElementById("currentPassword").value,t=document.getElementById("newPassword").value;try{var a=await(await fetch("/update-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPassword:e,newPassword:t})})).json(),o=document.querySelector(".status-message");a.success?(o.textContent=a.message,o.style.color="green",document.getElementById("passwordForm").reset()):(o.textContent=a.message||"An error occurred. Please try again.",o.style.color="red"),o.style.display="block"}catch(t){console.error("Error:",t);e=document.querySelector(".status-message");e.textContent="Something went wrong. Please try again.",e.style.color="red",e.style.display="block"}});let checkoutForm=document.getElementById("checkoutForm"),cardNumber=document.getElementById("cardNumber"),expiryDate=document.getElementById("expiryDate"),cvv=document.getElementById("cvv"),postalCode=document.getElementById("postalCode");async function loadCart(){try{var t=await(await fetch("/cart/items")).json();t.success&&(displayCartItems(t.cartItems),updateCartTotal(t.cartItems))}catch(t){M.toast({html:"Error loading cart items"})}}function displayCartItems(t){var e=document.getElementById("cartItems");0===t.length?e.innerHTML="<p>Your cart is empty</p>":(document.getElementById("checkoutBtn").disabled=0===t.length,e.innerHTML=t.map(t=>`
        <div class="cart-item" data-id="${t._id}">
        <img src="${t.productId.image||"https://placehold.co/100x100"}" alt="${t.productId.name}">
        <div class="item-details">
            <h5>${t.productId.name}</h5>
            <p>Retailer: ${t.productId.retailer}</p>
            <p>Price: $${t.productId.price}</p>
            <div class="quantity-controls">
            <button class="btn-small" onclick="updateQuantity('${t._id}', ${t.quantity-1})">-</button>
            <span>${t.quantity}</span>
            <button class="btn-small" onclick="updateQuantity('${t._id}', ${t.quantity+1})">+</button>
            </div>
            <button class="btn-small red" onclick="removeItem('${t._id}')">Remove</button>
        </div>
        </div>
    `).join(""))}async function updateQuantity(t,e){e<1||(await fetch("/cart/update/"+t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({quantity:e})})).ok&&(loadCart(),updateCartCount())}async function removeItem(t){(await fetch("/cart/delete/"+t,{method:"DELETE"})).ok&&(loadCart(),updateCartCount())}async function clearCart(){(await fetch("/cart/clear",{method:"DELETE"})).ok&&(loadCart(),updateCartCount())}function updateCartTotal(t){t=t.reduce((t,e)=>t+e.productId.price*e.quantity,0);document.getElementById("cartTotal").textContent=t.toFixed(2)}function checkout(){window.location.href="/checkout"}async function loadCheckoutItems(){try{var t=await(await fetch("/cart/items")).json();t.success&&(displayCheckoutItems(t.cartItems),updateTotalAmount(t.cartItems))}catch(t){M.toast({html:"Error loading cart items"})}}function displayCheckoutItems(t){document.getElementById("checkoutItems").innerHTML=t.map(t=>`
            <div class="checkout-item">
                <div class="item-info">
                    <img src="${t.productId.image||"https://placehold.co/100x100"}" alt="${t.productId.name}">
                    <div class="item-details">
                        <h6>${t.productId.name}</h6>
                        <p>Quantity: ${t.quantity}</p>
                        <p>Price: $${t.productId.price}</p>
                    </div>
                </div>
                <div class="item-total">
                    $${(t.productId.price*t.quantity).toFixed(2)}
                </div>
            </div>
        `).join("")}function updateTotalAmount(t){t=t.reduce((t,e)=>t+e.productId.price*e.quantity,0);document.getElementById("totalAmount").textContent=t.toFixed(2)}async function updateCartCount(){try{var t,e=await(await fetch("/cart/items")).json(),a=document.querySelector(".cart-count");e.success&&(t=e.cartItems.reduce((t,e)=>t+e.quantity,0),a)&&(a.textContent=t)}catch(t){console.error("Error updating cart count:",t)}}function adminNav(t,e){for(var a,o=document.getElementsByClassName("tabcontent"),n=0;n<o.length;n++)o[n].style.display="none";for(a=document.getElementsByClassName("tablinks"),tablist=document.getElementsByClassName("sidenav-items")[0].getElementsByTagName("li"),n=0;n<a.length;n++)a[n].classList.remove("active");for(n=0;n<tablist.length;n++)tablist[n].classList.remove("active");document.getElementById(e).style.display="block",t.currentTarget.classList.add("active"),t.currentTarget.closest("li").classList.add("active")}function showToast(t){M&&M.toast?M.toast({html:t}):console.error("Materialize is not loaded.")}checkoutForm?.addEventListener("submit",async t=>{t.preventDefault();var t=document.getElementById("error"),e=(t.textContent="",[]);if(isValidCardNumber(cardNumber.value)||e.push("Enter a valid card number(16 Digits)"),isValidExpiryDate(expiryDate.value)||e.push("The expiry date should be in MM/YY format"),isValidCVV(cvv.value)||e.push("Enter a valid CVV"),isValidPostalCode(postalCode.value)||e.push("Enter a valid postal code"),0<e.length)t.textContent=e.join(", ");else{t={cardNumber:cardNumber?.value,expiryDate:expiryDate?.value,cvv:cvv?.value,shippingAddress:{street:document.getElementById("street").value,city:document.getElementById("city").value,postalCode:postalCode?.value,country:document.getElementById("country").value}};try{var a=await(await fetch("/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();a.success&&(io("/order/"+a.order._id).on("statusUpdate",t=>{M.toast({html:"Order status: "+t.status}),updateNotifications(t)}),window.location.href="/order")}catch(t){M.toast({html:"Error creating order"})}}}),window.addEventListener("load",()=>{let t=document.querySelector(".loader-content");t?(document.body.style.overflow="hidden",setTimeout(()=>{t.style.display="none",document.body.style.overflow="auto"},2e3)):document.body.style.overflow="auto"}),window.addEventListener("DOMContentLoaded",()=>{let t=document.getElementById("authentication");var e=document.getElementById("register");let a=document.getElementById("register-form");var o=document.getElementById("login"),n=document.getElementById("logout"),d=document.getElementById("manageProduct"),r=document.getElementById("viewOrder"),c=document.getElementById("forgotPassword"),s=document.getElementById("back-to-sign-in"),i=document.getElementById("footer"),l=document.getElementById("toast__success"),u=document.getElementById("toast_error");let m=document.getElementById("userDropdownButton"),p=document.getElementById("userInfoPopup");var g=document.getElementById("searchForm"),y=document.getElementById("detailProductModal");let h=document.getElementById("fullName"),v=document.getElementById("emailRegister"),E=document.getElementById("passwordRegister");var I=document.getElementById("year"),f=document.getElementById("valid-form");let P=document.getElementById("error");var B=document.querySelectorAll(".sidenav"),w=window.location.pathname,u=l||u;I.textContent=(new Date).getFullYear(),M.Modal.init(y),M.Sidenav.init(B),updateCartCount();switch($("#userTable").DataTable({responsive:!0,paging:!0,searching:!0,ordering:!0,pageLength:5}),null!==u&&(I=u.getAttribute("data-message"),M.toast({html:I,classes:"toast "+(l?"toast__success":"toast__error"),displayLength:4e3})),w){case"/":case"/dashboard":i.style.display="none","/dashboard"===w&&(d.addEventListener("click",adminFetchProducts),r.addEventListener("click",fetchOrders),adminModal(["Technology","Clothing","Food","Home & Garden","Sports & Outdoors","Books","Beauty & Health","Toys & Games","Automotive","Pet Supplies"],["Amazon","Walmart","Target","Best Buy","Costco","eBay","Newegg","Home Depot","Macy's","PetSmart"]));break;case"/homepage":fetchProducts();break;case"/cart":loadCart();break;case"/checkout":loadCheckoutItems()}window.addEventListener("scroll",function(){var t=document.querySelector(".nav");0<window.scrollY?t.classList.add("navbar-scrolled"):t.classList.remove("navbar-scrolled")}),e?.addEventListener("click",()=>{t.classList.add("active")}),f?.addEventListener("click",t=>{t.preventDefault();P.textContent="";t=[];h.value||t.push("Name should not be empty"),v.value?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v.value)||t.push("Please enter a valid email."):t.push("Please enter your email address."),E.value?/^(?=.*[!@#$%^&*])[\S]{8,}$/.test(E.value)||t.push("Password should be at least 8 characters and contain at least 1 special character (!@#$%^&*)."):t.push("Please enter a password."),0<t.length?P.textContent=t.join(", "):a?.submit()}),o?.addEventListener("click",()=>{t.classList.remove("active")}),n?.addEventListener("click",()=>{fetch("/logout",{method:"POST",credentials:"include"}).then(t=>{t.ok&&(window.location.href="/")}).catch(t=>{console.error("Error logging out:",t)})}),c?.addEventListener("click",t=>{t.preventDefault(),document.getElementById("sign-in-form").style.display="none",document.getElementById("forgot-password-container").style.display="block"}),s?.addEventListener("click",t=>{t.preventDefault(),document.getElementById("sign-in-form").style.display="block",document.getElementById("forgot-password-container").style.display="none"}),g?.addEventListener("submit",t=>{t.preventDefault(),fetchProducts()});y=document.querySelectorAll("select");M.FormSelect.init(y),m&&p&&(B=(m.textContent||m.innerText).charAt(0).toUpperCase(),m.textContent=B,document.addEventListener("click",t=>{t.target===m?(t.preventDefault(),p.classList.toggle("active")):p.contains(t.target)||p.classList.remove("active")}))});let productsList=[];async function fetchProducts(t=1){try{var e=document.getElementById("search").value,a=document.getElementById("retailer").value,o=document.getElementById("sortBy").value,n=document.getElementById("order").value,d=new URLSearchParams({search:e,retailer:a,sortBy:o,order:n,page:t,limit:12}),r=await(await fetch("/products?"+d)).json();r.success?(displayProducts(productsList=r.data),displayPagination(r.pagination),showNewestProduct()):M.toast({html:"Error loading products"})}catch(t){console.error("Error:",t),M.toast({html:"Error loading products"})}}function displayProducts(t){document.getElementById("productsContainer").innerHTML=t.map(t=>0!=t.quantity?`
            <div class="col s12 m6 l3">
                <div class="card" onclick="showProductDetails('${t._id}')">
                <div class="card-image">
                    <img src="${t.image||`https://placehold.co/400x300?text=IMG:${t.name}&font=playfair-display`}">
                    <span class="card-title">${t.name}</span>
                    <a class="btn-floating halfway-fab waves-effect waves-light red" onclick="addToCart('${t._id}', event)">
                    <i class="add_button">Add</i>
                    </a>
                </div>
                <div class="card-content">
                    <p class="price">Price: $${t.price}</p>
                    <p class="quantity">Quantity: ${t.quantity}</p>
                    <p>${t.description}</p>
                    <p class="retailer">Retailer: ${t.retailer}</p>
                </div>
                </div>
            </div> `:`
                <div>
                 <p> No product found </p>
                </div>
                `).join("")}function displayPagination(a){if(a){var t=document.getElementById("pagination");let e=`
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
          `;e=(e+='<ul class="pagination">')+`
            <li class="${1===a.currentPage?"disabled":""}">
              <a href="#!" onclick="${1<a.currentPage?`fetchProducts(${a.currentPage-1})`:""}">
                <i class="fas fa-chevron-left"></i>
              </a>
            </li>
          `;var o=Math.max(1,a.currentPage-Math.floor(2.5)),n=Math.min(a.totalPages,o+5-1);for(let t=o;t<=n;t++)e+=`
              <li class="${a.currentPage===t?"active":""}">
                <a href="#!" onclick="fetchProducts(${t})">${t}</a>
              </li>
            `;n<a.totalPages&&(e+=`
              <li class="disabled">
                <a href="#!">...</a>
              </li>
              <li>
                <a href="#!" onclick="fetchProducts(${a.totalPages})">${a.totalPages}</a>
              </li>
            `),e=(e=e+`
            <li class="${a.currentPage===a.totalPages?"disabled":""}">
              <a href="#!" onclick="${a.currentPage<a.totalPages?`fetchProducts(${a.currentPage+1})`:""}">
                <i class="fas fa-chevron-right"></i>
              </a>
            </li>
          `+"</ul>")+`
            <div class="pagination-jump">
              <label for="jumpPage">Go to page:</label>
              <input type="number" id="jumpPage" min="1" max="${a.totalPages}" value="${a.currentPage}">
              <button onclick="jumpToPage(${a.totalPages})">Go</button>
            </div>
          `+"</div>",t.innerHTML=e}}function jumpToPage(t){var e=document.getElementById("jumpPage"),e=parseInt(e.value,10);!isNaN(e)&&1<=e&&e<=t?fetchProducts(e):showToast("Please enter a valid page number.")}async function addToCart(t,e){e.stopPropagation();try{(await(await fetch("/cart/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productId:t})})).json()).success?(M.toast({html:"Item added to cart"}),updateCartCount()):M.toast({html:"Cannot add more"})}catch(t){M.toast({html:"Error adding item to cart"})}}function showNewestProduct(){let a=document.getElementById("newestProducts");var t;Array.isArray(productsList)&&0!==productsList.length?(t=productsList.filter(t=>t.createdAt&&!isNaN(new Date(t.createdAt).getTime())).sort((t,e)=>new Date(e.createdAt)-new Date(t.createdAt)).slice(0,5),a.innerHTML="",t.forEach(t=>{var e=document.createElement("div");e.classList.add("product"),e.innerHTML=`
            <img src="${t.images[0]}" alt="${t.name}">
        `,a.appendChild(e)})):console.log("No products available to display.")}function showProductDetails(e){let a=productsList.find(t=>t._id===e);var t=document.getElementById("productName"),o=document.getElementById("productCategory"),n=document.getElementById("productPrice"),d=document.getElementById("productDesc"),r=document.getElementById("similarProductsContainer");let c=document.getElementById("productImageCarousel");a?(t.innerText=a.name,o.innerText=a.category,n.innerText=a.price,d.innerText=a.description,c.innerHTML="",a.images.forEach(t=>{var e=document.createElement("a");e.classList.add("carousel-item"),e.href="#",e.innerHTML=`<img src="${t}" alt="${a.name}">`,c.appendChild(e)}),setTimeout(()=>{M.Carousel.init(c,{fullWidth:!1,indicators:!0}).set(1)},100),t=productsList.filter(t=>t.category===a.category&&t._id!==e).slice(0,5),r.innerHTML=t.map(t=>`
        <div class="similar-product" onclick="showProductDetails('${t._id}')">
            <img src="${t.image||"https://placehold.co/100x100"}" alt="${t.name}">
            <p>${t.name}</p>
        </div>
    `).join(""),M.Modal.getInstance(document.getElementById("detailProductModal")).open()):M.toast({html:"Product not found!"})}let notifications=[];function updateNotifications(t){notifications.unshift(t);var e=document.querySelector(".notification-count"),e=(e&&(e.textContent=notifications.length),document.getElementById("notifications-dropdown"));e&&(e.innerHTML=notifications.map(t=>`
                    <li>
                        <a href="#!" class="notification-item">
                            <span class="notification-message">${t.message}</span>
                            <span class="notification-time">${new Date(t.timestamp).toLocaleTimeString()}</span>
                        </a>
                    </li>
                `).join("")),showToast(t.message)}let socket=io(),isValidCardNumber=(socket.on("connect",()=>{console.log("Connected to socket server")}),socket.on("connect_error",t=>{console.error("Socket connection error:",t)}),socket.on("notification-"+userId,t=>{console.log("Received notification:",t),updateNotifications(t)}),socket.on("newMessage",t=>{console.log("New message received:",t),showToast(t.text)}),t=>/^\d{16}$/.test(t)),isValidExpiryDate=t=>/^\d{2}\/\d{2}$/.test(t),isValidCVV=t=>/^\d{3}$/.test(t),isValidPostalCode=t=>/(^\d{5}$)|(^\d{5}-\d{4}$)/.test(t);